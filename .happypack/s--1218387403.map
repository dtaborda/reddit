{"version":3,"sources":["app/api/api.js"],"names":["TIMEOUT","makeUrl","url","newUrl","isArray","join","__CLIENT__","apiHost","apiPort","removeValue","arr","value","remove","item","_pendingRequests","abortPendingRequestsForApiCall","apiCallName","pendingRequest","find","pending","_apiCallName","_callback","abort","isSuccessStatus","status","defaultParser","res","result","done","body","fail","digestResponse","resolve","reject","error","request","response","options","timeout","apiError","apiResponse","gotExpectedResponse","parser","parse","data","err","pass","call","executeRequestFlow","origReq","Promise","requestPromise","method","absolutePath","path","query","indexOf","accept","type","send","Object","keys","forEach","processKey","key","undefined","console","warn","headers","isPlainObject","set","extend","length","cancelPendingRequests","dashapiCallName","log","end","push","Api"],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;;;;;AAEA,IAAMA,UAAU,KAAhB;;AAEA,SAASC,OAAT,CAAiBC,GAAjB,EAAsB;AACpB,MAAIC,SAASD,GAAb;AACA,MAAI,iBAAKE,OAAL,CAAaD,MAAb,CAAJ,EAA0B;AACxBA,aAAS,MAAMA,OAAOE,IAAP,CAAY,GAAZ,CAAf;AACD;AACD,MAAIC,UAAJ,EAAgB;AACdH,aAAS,SAASA,MAAlB;AACD,GAFD,MAEO;AACLA,aAAS,YAAY,iBAAOI,OAAnB,GAA6B,GAA7B,GAAmC,iBAAOC,OAA1C,GAAoDL,MAA7D;AACD;AACD,SAAOA,MAAP;AACD;;AAED,SAASM,WAAT,CAAqBC,GAArB,EAA0BC,KAA1B,EAAiC;AAC/B,mBAAKC,MAAL,CAAYF,GAAZ,EAAiB,UAACG,IAAD;AAAA,WAAUA,SAASF,KAAnB;AAAA,GAAjB;AACD;;AAED,IAAMG,mBAAmB,EAAzB;;AAEA;AACA;AACA;AACA;AACA,SAASC,8BAAT,CAAwCC,WAAxC,EAAqD;AACnD,MAAMC,iBAAiB,iBAAKC,IAAL,CAAUJ,gBAAV,EAA4B,UAACK,OAAD,EAAa;AAC9D,WAAOA,QAAQC,YAAR,KAAyBJ,WAAhC;AACD,GAFsB,CAAvB;;AAIA,MAAIC,cAAJ,EAAoB;AAClBA,mBAAeI,SAAf,GAA2B,YAAM,CAAE,CAAnC;AACAJ,mBAAeK,KAAf;AACAb,gBAAYK,gBAAZ,EAA8BG,cAA9B;AACD;AACF;;AAED,SAASM,gBAAT,CAAyBC,MAAzB,EAAiC;AAC/B,SAAOA,UAAU,GAAV,IAAiBA,UAAU,GAAlC;AACD;;AAED,SAASC,aAAT,CAAuBC,GAAvB,EAA4B;AAC1B,MAAIC,SAAS,IAAb;AACA,MAAIJ,iBAAgBG,IAAIF,MAApB,CAAJ,EAAiC;AAC/BG,aAAS,KAAKC,IAAL,CAAUF,IAAIG,IAAd,CAAT;AACD,GAFD,MAEO;AACLF,aAAS,KAAKG,IAAL,CAAUJ,IAAIG,IAAd,CAAT;AACD;AACD,SAAOF,MAAP;AACD;;AAED,SAASI,cAAT,CAAwBC,OAAxB,EAAiCC,MAAjC,EAAyCC,KAAzC,EAAgDC,OAAhD,EAAyDC,QAAzD,EAAmEC,OAAnE,EAA4E;AAC1E,MAAMV,SAAS,EAAf;;AAEA;AACA,MAAIO,SAASA,MAAMI,OAAN,IAAiB,CAA9B,EAAiC;AAC/BX,WAAOY,QAAP,GAAkB,SAAlB;AACAN,WAAON,MAAP;;AAEF;AACC,GALD,MAKO,IAAIS,YAAYA,SAASZ,MAAT,KAAoB,GAApC,EAAyC;AAC9CG,WAAOa,WAAP,GAAqBJ,SAASP,IAAT,IAAiB,EAAtC;AACAF,WAAOY,QAAP,GAAkB,YAAlB;AACAN,WAAON,MAAP;;AAEF;AACA;AACC,GAPM,MAOA,IAAIS,YAAaA,SAASZ,MAAT,IAAmB,GAAnB,IAA0BY,SAASZ,MAAT,IAAmB,GAA1D,IAAkEY,SAASZ,MAAT,GAAkB,KAAxF,EAA+F;AACpGG,WAAOa,WAAP,GAAqBJ,SAASP,IAAT,IAAiB,EAAtC;AACAF,WAAOY,QAAP,GAAkB,WAAlB;AACAN,WAAON,MAAP;AACD,GAJM,MAIA,IAAIS,YAAYA,SAASZ,MAAT,KAAoB,GAApC,EAAyC;AAC9CG,WAAOa,WAAP,GAAqBJ,SAASP,IAAT,IAAiB,EAAtC;AACAF,WAAOY,QAAP,GAAkB,kBAAlB;AACAN,WAAON,MAAP;;AAEF;AACC,GANM,MAMA,IAAIO,KAAJ,EAAW;AAChBP,WAAOa,WAAP,GAAqBJ,SAASP,IAAT,IAAiB,EAAtC;AACAF,WAAOY,QAAP,GAAkB,OAAlB;AACAN,WAAON,MAAP;AACD,GAJM,MAIA;AACLS,aAASP,IAAT,GAAgBO,SAASP,IAAT,IAAiB,EAAjC,CADK,CACgC;AACrC,QAAIY,4BAAJ;AACA,QAAMC,SAASL,QAAQM,KAAR,IAAiBlB,aAAhC;;AAEA,QAAMG,OAAO,SAASA,IAAT,CAAcgB,IAAd,EAAoB;AAC/BH,4BAAsB,IAAtB;AACAd,aAAOa,WAAP,GAAqBI,QAAQ,EAA7B;AACAZ,cAAQL,MAAR;AACD,KAJD;;AAMA,QAAMG,OAAO,SAASA,IAAT,CAAce,GAAd,EAAmB;AAC9BJ,4BAAsB,IAAtB;AACAd,aAAOa,WAAP,GAAqBK,OAAO,EAA5B;AACAlB,aAAOY,QAAP,GAAkBM,GAAlB;AACAZ,aAAON,MAAP;AACD,KALD;;AAOA,QAAMmB,OAAO,SAASA,IAAT,GAAgB;AAC3B;AACAL,4BAAsB,IAAtB;AACD,KAHD;;AAKAC,WAAOK,IAAP,CAAY,EAAEnB,UAAF,EAAQE,UAAR,EAAcgB,UAAd,EAAZ,EAAkCV,QAAlC;;AAEA;AACA,QAAI,CAACK,mBAAL,EAA0B;AACxBd,aAAOY,QAAP,GAAkB,cAAlB;AACAN,aAAON,MAAP;AACD;AACF;AACF;;AAED,SAASqB,kBAAT,CAA4BX,OAA5B,EAAqCY,OAArC,EAA8C;AAC5C,SAAO,IAAIC,OAAJ,CAAY,SAASC,cAAT,CAAwBnB,OAAxB,EAAiCC,MAAjC,EAAyC;AAC1DI,YAAQe,MAAR,GAAiBf,QAAQe,MAAR,IAAkB,KAAnC;AACA,QAAMlD,MAAMmC,QAAQgB,YAAR,IAAwBpD,QAAQoC,QAAQiB,IAAhB,CAApC;AACA,QAAMnB,UAAU,0BAASE,QAAQe,MAAjB,EAAyBlD,GAAzB,CAAhB;AACA,QAAMqD,QAAQ,EAAd;AACA,QAAI,CAAC,KAAD,EAAQ,MAAR,EAAgB,KAAhB,EAAuBC,OAAvB,CAA+BnB,QAAQe,MAAvC,IAAiD,CAAC,CAAtD,EAAyD;AACvDjB,cAAQsB,MAAR,CAAe,MAAf;AACAtB,cAAQuB,IAAR,CAAa,MAAb;AACD;;AAED,QAAI,CAAC,MAAD,EAAS,KAAT,EAAgBF,OAAhB,CAAwBnB,QAAQe,MAAhC,IAA0C,CAAC,CAA/C,EAAkD;AAChDf,cAAQR,IAAR,GAAeQ,QAAQR,IAAR,IAAgB,EAA/B;AACD;;AAED;AACA;;AAEA,QAAIQ,QAAQR,IAAZ,EAAkB;AAChBM,cAAQwB,IAAR,CAAatB,QAAQR,IAArB;AACA+B,aAAOC,IAAP,CAAYxB,QAAQR,IAApB,EAA0BiC,OAA1B,CAAkC,SAASC,UAAT,CAAoBC,GAApB,EAAyB;AACzD,YAAI3B,QAAQR,IAAR,CAAamC,GAAb,MAAsBC,SAA1B,EAAqC;AACnCC,kBAAQC,IAAR,CAAa,oCAAb,EAAmDH,GAAnD;AACD;AACF,OAJD;AAKD;;AAED,QAAI3B,QAAQ+B,OAAR,IAAmB,iBAAKC,aAAL,CAAmBhC,QAAQ+B,OAA3B,CAAvB,EAA4D;AAC1DjC,cAAQmC,GAAR,CAAYjC,QAAQ+B,OAApB;AACD;;AAED,QAAI/B,QAAQkB,KAAZ,EAAmB;AACjB,uBAAKgB,MAAL,CAAYhB,KAAZ,EAAmBlB,QAAQkB,KAA3B;AACD;;AAED,QAAIK,OAAOC,IAAP,CAAYN,KAAZ,EAAmBiB,MAAvB,EAA+B;AAC7BrC,cAAQoB,KAAR,CAAcA,KAAd;AACD;;AAEDpB,YAAQG,OAAR,CAAgBtC,OAAhB;;AAEA;AACA,QAAIqC,QAAQoC,qBAAZ,EAAmC;AACjC,UAAItC,QAAQuC,eAAZ,EAA6BR,QAAQS,GAAR,CAAY,4CAAZ;AAC7B,UAAI,CAACtC,QAAQrB,WAAb,EAA0BkD,QAAQS,GAAR,CAAY,sEAAZ;;AAE1BxC,cAAQf,YAAR,GAAuBiB,QAAQrB,WAA/B;;AAEAD,qCAA+BsB,QAAQrB,WAAvC;AACD;;AAED;AACAmB,YAAQyC,GAAR,CAAY,UAAC1C,KAAD,EAA0B;AAAA,UAAlBE,QAAkB,uEAAP,EAAO;;AACpCL,qBAAeC,OAAf,EAAwBC,MAAxB,EAAgCC,KAAhC,EAAuCC,OAAvC,EAAgDC,QAAhD,EAA0DC,OAA1D;AACA5B,kBAAYK,gBAAZ,EAA8BqB,OAA9B;AACD,KAHD;;AAKArB,qBAAiB+D,IAAjB,CAAsB1C,OAAtB;AACD,GAzDM,CAAP;AA0DD;;AAED;;IACqB2C,G;AAEnB,eAAY7B,OAAZ,EAAqB;AAAA;;AACnB,SAAKA,OAAL,GAAeA,OAAf;AACD;;;;wBAEGZ,O,EAAS;AACXA,cAAQe,MAAR,GAAiB,KAAjB;AACA,aAAOJ,mBAAmBX,OAAnB,EAA4B,KAAKY,OAAjC,CAAP;AACD;;;wBAEGZ,O,EAAS;AACXA,cAAQe,MAAR,GAAiB,KAAjB;AACA,aAAOJ,mBAAmBX,OAAnB,EAA4B,KAAKY,OAAjC,CAAP;AACD;;;yBAEIZ,O,EAAS;AACZA,cAAQe,MAAR,GAAiB,MAAjB;AACA,aAAOJ,mBAAmBX,OAAnB,EAA4B,KAAKY,OAAjC,CAAP;AACD;;;4BAEMZ,O,EAAS;AACdA,cAAQe,MAAR,GAAiB,QAAjB;AACA,aAAOJ,mBAAmBX,OAAnB,EAA4B,KAAKY,OAAjC,CAAP;AACD;;;yBAEIZ,O,EAAS;AACZA,cAAQe,MAAR,GAAiB,MAAjB;AACA,aAAOJ,mBAAmBX,OAAnB,EAA4B,KAAKY,OAAjC,CAAP;AACD;;;oCAEezB,M,EAAQ;AACtB,aAAOD,iBAAgBC,MAAhB,CAAP;AACD;;;;;;kBAjCkBsD,G;;;;;;;;gCAhLf9E,O;;gCAEGC,O;;gCAaAQ,W;;gCAIHK,gB;;gCAMGC,8B;;gCAYAQ,gB;;gCAIAE,a;;gCAUAM,c;;gCA+DAiB,kB;;gCA8DY8B,G","file":"api.js","sourceRoot":"/Users/damian.taborda/ws/whiteprompt/reddit/DamianTaborda_WebCodeChallenge","sourcesContent":["import requestF from 'superagent';\nimport dash from 'lodash';\nimport config from '../config';\n\nconst TIMEOUT = 15000;\n\nfunction makeUrl(url) {\n  let newUrl = url;\n  if (dash.isArray(newUrl)) {\n    newUrl = '/' + newUrl.join('/');\n  }\n  if (__CLIENT__) {\n    newUrl = '/api' + newUrl;\n  } else {\n    newUrl = 'http://' + config.apiHost + ':' + config.apiPort + newUrl;\n  }\n  return newUrl;\n}\n\nfunction removeValue(arr, value) {\n  dash.remove(arr, (item) => item === value);\n}\n\nconst _pendingRequests = [];\n\n// Abor the requests for the Api Call with the specified name.\n// Be careful since won't make any difference if the same api call gets\n// called with diffrent query strings or body, this feature stops any\n// pending call for the specified Api Call\nfunction abortPendingRequestsForApiCall(apiCallName) {\n  const pendingRequest = dash.find(_pendingRequests, (pending) => {\n    return pending._apiCallName === apiCallName;\n  });\n\n  if (pendingRequest) {\n    pendingRequest._callback = () => {};\n    pendingRequest.abort();\n    removeValue(_pendingRequests, pendingRequest);\n  }\n}\n\nfunction isSuccessStatus(status) {\n  return status >= 200 && status <= 299;\n}\n\nfunction defaultParser(res) {\n  let result = null;\n  if (isSuccessStatus(res.status)) {\n    result = this.done(res.body);\n  } else {\n    result = this.fail(res.body);\n  }\n  return result;\n}\n\nfunction digestResponse(resolve, reject, error, request, response, options) {\n  const result = {};\n\n  // Autofail with standard api error on timeout.\n  if (error && error.timeout >= 0) {\n    result.apiError = 'TIMEOUT';\n    reject(result);\n\n  // Auto-fail with special auth error on 401.\n  } else if (response && response.status === 401) {\n    result.apiResponse = response.body || {};\n    result.apiError = 'AUTH_ERROR';\n    reject(result);\n\n  // Auto-fail with special api down error on 502 - 504.\n  // IE can do weird things with 5xx errors like call them 12031s.\n  } else if (response && (response.status >= 502 && response.status <= 504) || response.status > 12000) {\n    result.apiResponse = response.body || {};\n    result.apiError = '500_ERROR';\n    reject(result);\n  } else if (response && response.status === 429) {\n    result.apiResponse = response.body || {};\n    result.apiError = 'RATE_LIMIT_ERROR';\n    reject(result);\n\n  // Autofail with standard api error.\n  } else if (error) {\n    result.apiResponse = response.body || {};\n    result.apiError = 'ERROR';\n    reject(result);\n  } else {\n    response.body = response.body || {}; // patch response.body if nonexistant\n    let gotExpectedResponse;\n    const parser = options.parse || defaultParser;\n\n    const done = function done(data) {\n      gotExpectedResponse = true;\n      result.apiResponse = data || {};\n      resolve(result);\n    };\n\n    const fail = function fail(err) {\n      gotExpectedResponse = true;\n      result.apiResponse = err || {};\n      result.apiError = err;\n      reject(result);\n    };\n\n    const pass = function pass() {\n      // do nothing.  don't resolve or reject the promise.\n      gotExpectedResponse = true;\n    };\n\n    parser.call({ done, fail, pass }, response);\n\n    // Our parser did not get a response it understands\n    if (!gotExpectedResponse) {\n      result.apiError = 'UNKOWN ERROR';\n      reject(result);\n    }\n  }\n}\n\nfunction executeRequestFlow(options, origReq) {\n  return new Promise(function requestPromise(resolve, reject) {\n    options.method = options.method || 'GET';\n    const url = options.absolutePath || makeUrl(options.path);\n    const request = requestF(options.method, url);\n    const query = {};\n    if (['GET', 'POST', 'PUT'].indexOf(options.method) > -1) {\n      request.accept('json');\n      request.type('json');\n    }\n\n    if (['POST', 'PUT'].indexOf(options.method) > -1) {\n      options.body = options.body || {};\n    }\n\n    // If you need to set a cookie do as follow:\n    // request.set('Cookie', sessionCookie);\n\n    if (options.body) {\n      request.send(options.body);\n      Object.keys(options.body).forEach(function processKey(key) {\n        if (options.body[key] === undefined) {\n          console.warn('Key was undefined in request body:', key);\n        }\n      });\n    }\n\n    if (options.headers && dash.isPlainObject(options.headers)) {\n      request.set(options.headers);\n    }\n\n    if (options.query) {\n      dash.extend(query, options.query);\n    }\n\n    if (Object.keys(query).length) {\n      request.query(query);\n    }\n\n    request.timeout(TIMEOUT);\n\n    // Prevent concurrent calls for the same Api Call type.\n    if (options.cancelPendingRequests) {\n      if (request.dashapiCallName) console.log('WARNING: Prop clashing with request object');\n      if (!options.apiCallName) console.log('WARNING: To cancel previous calls the Api Call needs a name defined.');\n\n      request._apiCallName = options.apiCallName;\n\n      abortPendingRequestsForApiCall(options.apiCallName);\n    }\n\n    // Request Callback logic\n    request.end((error, response = {}) => {\n      digestResponse(resolve, reject, error, request, response, options);\n      removeValue(_pendingRequests, request);\n    });\n\n    _pendingRequests.push(request);\n  });\n}\n\n// API Interface\nexport default class Api {\n\n  constructor(origReq) {\n    this.origReq = origReq;\n  }\n\n  get(options) {\n    options.method = 'GET';\n    return executeRequestFlow(options, this.origReq);\n  }\n\n  put(options) {\n    options.method = 'PUT';\n    return executeRequestFlow(options, this.origReq);\n  }\n\n  post(options) {\n    options.method = 'POST';\n    return executeRequestFlow(options, this.origReq);\n  }\n\n  delete(options) {\n    options.method = 'DELETE';\n    return executeRequestFlow(options, this.origReq);\n  }\n\n  head(options) {\n    options.method = 'HEAD';\n    return executeRequestFlow(options, this.origReq);\n  }\n\n  isSuccessStatus(status) {\n    return isSuccessStatus(status);\n  }\n\n}\n"]}